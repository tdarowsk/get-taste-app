---
import AuthLayout from "../../layouts/AuthLayout.astro";
import { PasswordResetForm } from "../../components/auth/PasswordResetForm";
import { supabaseClient } from "../../db/supabase.client.ts";

// Sprawdź, czy użytkownik jest już zalogowany
const {
  data: { session },
} = await supabaseClient.auth.getSession();

// Jeśli użytkownik jest zalogowany, przekieruj go na dashboard
if (session) {
  return Astro.redirect("/dashboard");
}

// Sprawdź, czy jest to formularz żądania resetowania hasła czy ustawiania nowego hasła
const token = Astro.url.searchParams.get("token");
const mode = token ? "reset" : "request";
---

<AuthLayout title="Resetowanie hasła - getTaste">
  <PasswordResetForm
    client:load
    mode={mode}
    token={token}
    onResetSuccess={() => {
      // Logika przekierowania po resecie hasła jest obsługiwana w skrypcie klienta
    }}
  />
</AuthLayout>

<script>
  // Skrypt klienta zapewniający przekierowanie po pomyślnym resecie hasła
  document.addEventListener("astro:page-load", () => {
    // Po pomyślnym resecie hasła przekierujemy do strony logowania
    document.addEventListener("reset:success", () => {
      window.location.href = "/auth/login";
    });
  });
</script>
