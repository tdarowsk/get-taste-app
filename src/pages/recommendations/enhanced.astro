---
import Layout from "../../layouts/Layout.astro";
import { ImprovedRecommendationsView } from "../../components/ImprovedRecommendationsView";
import { createSupabaseServerInstance } from "../../db/supabase.client";

// Utwórz instancję Supabase z odpowiednim kontekstem
const supabase = createSupabaseServerInstance({
  headers: Astro.request.headers,
  cookies: Astro.cookies,
});

// Sprawdź sesję użytkownika
const {
  data: { session },
  error,
} = await supabase.auth.getSession();

// Jeśli nie ma sesji lub wystąpił błąd, przekieruj na stronę logowania
if (!session || error) {
  return Astro.redirect("/auth/login?redirect=/recommendations/enhanced");
}

// Użyj ID użytkownika z sesji
const userId = session.user.id;
---

<Layout title="Zaawansowane rekomendacje | getTaste">
  <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white">
    <ImprovedRecommendationsView userId={userId} client:only="react" />
  </div>
</Layout>

<script>
  // This ensures the component is hydrated properly with client-side navigation
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('[data-reactroot]').forEach(el => {
      el.removeAttribute('data-reactroot');
    });
  });
</script>
