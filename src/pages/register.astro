---
import Layout from "../layouts/Layout.astro";
import { supabaseClient } from "../db/supabase.client.ts";

// Check if user is already authenticated
const {
  data: { session },
} = await supabaseClient.auth.getSession();

// If user is authenticated, redirect to dashboard
if (session) {
  return Astro.redirect("/dashboard");
}
---

<Layout title="Rejestracja - getTaste">
  <main class="container mx-auto px-4 py-12 max-w-md">
    <div class="bg-white/5 rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold mb-6 text-center">Utwórz konto w getTaste</h1>

      <form id="register-form" class="space-y-6">
        <div>
          <label for="email" class="block mb-2">Email</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-2 rounded-md bg-white/10 border border-white/20 focus:border-purple-500 focus:outline-none"
          />
        </div>

        <div>
          <label for="password" class="block mb-2">Hasło</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="8"
            class="w-full px-4 py-2 rounded-md bg-white/10 border border-white/20 focus:border-purple-500 focus:outline-none"
          />
          <p class="text-xs text-gray-400 mt-1">Minimum 8 znaków</p>
        </div>

        <div>
          <label for="nick" class="block mb-2">Nick</label>
          <input
            type="text"
            id="nick"
            name="nick"
            required
            class="w-full px-4 py-2 rounded-md bg-white/10 border border-white/20 focus:border-purple-500 focus:outline-none"
          />
        </div>

        <div id="error-message" class="text-red-500 hidden"></div>

        <button
          type="submit"
          class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 px-8 rounded-md shadow-md hover:from-purple-700 hover:to-indigo-700 transition-all duration-300"
        >
          Zarejestruj się
        </button>
      </form>

      <div class="mt-6 text-center">
        <p>Masz już konto? <a href="/login" class="text-purple-400 hover:text-purple-300">Zaloguj się</a></p>
      </div>
    </div>
  </main>
</Layout>

<script is:inline>
  // Handle registration form submission
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("register-form");
    const errorMessage = document.getElementById("error-message");

    if (form && errorMessage) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Bezpieczne pobieranie wartości z formularza
        const email = form.querySelector("#email").value;
        const password = form.querySelector("#password").value;
        const nick = form.querySelector("#nick").value;

        try {
          // Clear any previous error messages
          errorMessage.textContent = "";
          errorMessage.classList.add("hidden");

          // Użyj bezpiecznego API endpointu zamiast bezpośredniej rejestracji
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password, nick }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || "Wystąpił błąd podczas rejestracji");
          }

          // Redirect to dashboard on successful registration
          window.location.href = "/dashboard";
        } catch (error) {
          // Display error message
          let errorMsg = "Wystąpił błąd podczas rejestracji. Spróbuj ponownie.";
          if (error instanceof Error) {
            errorMsg = error.message;
          }
          errorMessage.textContent = errorMsg;
          errorMessage.classList.remove("hidden");
        }
      });
    }
  });
</script>
